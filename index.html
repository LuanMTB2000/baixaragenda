<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamentos - A partir de Hoje</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .card-agendamento {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .card-agendamento:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .card-agendamento h3 {
            color: #2c3e50;
            margin-top: 0;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
        }
        
        .info-label {
            font-weight: bold;
            color: #34495e;
            margin-right: 8px;
            min-width: 80px;
        }
        
        .status-agendado { 
            color: #f39c12; 
            font-weight: bold;
        }
        
        .status-confirmado { 
            color: #27ae60; 
            font-weight: bold;
        }
        
        .status-cancelado { 
            color: #e74c3c; 
            font-weight: bold;
        }
        
        .observacoes {
            background-color: #f8f9fa;
            padding: 10px;
            border-left: 4px solid #3498db;
            margin-top: 15px;
            border-radius: 0 4px 4px 0;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            background: white;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .error {
            background-color: #ffe6e6;
            color: #d63031;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #d63031;
        }
        
        .refresh-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
            margin-right: 10px;
            transition: background-color 0.3s;
        }
        
        .refresh-btn:hover {
            background-color: #2980b9;
        }
        
        .csv-btn {
            background-color: #16a085;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .csv-btn:hover {
            background-color: #138d75;
        }
        
        .buttons-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .search-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .search-btn {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .search-btn:hover {
            background-color: #229954;
        }
        
        .clear-btn {
            background-color: #95a5a6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .clear-btn:hover {
            background-color: #7f8c8d;
        }
        
        .filtro-ativo {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .data-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 30px 0 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .data-titulo {
            font-size: 1.4em;
            font-weight: bold;
            margin: 0;
        }
        
        .pdf-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .pdf-btn:hover {
            background-color: #c0392b;
            transform: translateY(-1px);
        }
        
        .agendamentos-do-dia {
            margin-bottom: 40px;
        }
        
        .estatisticas-mrjack {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .estatisticas-mrjack h2 {
            margin: 0 0 15px 0;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.95;
        }
        
        .whatsapp-btn {
            background-color: #25D366;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            text-decoration: none;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .whatsapp-btn:hover {
            background-color: #20BA5A;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .whatsapp-icon {
            font-size: 18px;
        }
        
        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>üìÖ Agendamentos a partir de Hoje</h1>
    
    <div class="buttons-container">
        <button class="refresh-btn" onclick="carregarAgendamentos()">üîÑ Atualizar Lista</button>
        <button class="csv-btn" onclick="baixarCSVClientes()">üìä Baixar CSV de Clientes</button>
    </div>
    
    <div class="search-container">
        <input 
            type="date" 
            id="dataBusca" 
            class="search-input"
            placeholder="Selecione uma data"
        >
        <button class="search-btn" onclick="filtrarPorData()">
            üîç Buscar Data
        </button>
        <button class="clear-btn" onclick="limparFiltro()">
            ‚úñÔ∏è Limpar Filtro
        </button>
    </div>
    
    <div id="filtroAtivo"></div>
    
    <div id="estatisticasMrJack"></div>
    
    <div id="listaAgendamentos">
        <div class="loading">Carregando agendamentos...</div>
    </div>

    <!-- jsPDF para gerar PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Firebase SDK v10 -->
    <script type="module">
        // Importar Firebase SDK v10
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js';
        import { getFirestore, collection, query, where, getDocs, orderBy } from 'https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js';

        // Configura√ß√£o do Firebase - Agenda Mr. Jack
        const firebaseConfig = {
            apiKey: "AIzaSyBaDBgoPIBCyG1IFAuvIpoJ26P88tTu6dQ",
            authDomain: "agenda-mr-jack.firebaseapp.com",
            projectId: "agenda-mr-jack",
            storageBucket: "agenda-mr-jack.firebasestorage.app",
            messagingSenderId: "792947416467",
            appId: "1:792947416467:web:9c8aa1b17306bd4cef1c66",
            measurementId: "G-XHKRJPSNJC"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Vari√°vel global para armazenar todos os agendamentos
        let todosAgendamentos = [];
        let dataFiltrada = null;

        // Fun√ß√£o para formatar data brasileira
        function formatarDataBR(dataString) {
            const [ano, mes, dia] = dataString.split('-');
            return `${dia}/${mes}/${ano}`;
        }

        // Fun√ß√£o para formatar data por extenso
        function formatarDataExtenso(dataString) {
            const data = new Date(dataString + 'T00:00:00');
            const dia = data.getDate();
            const meses = ['janeiro', 'fevereiro', 'mar√ßo', 'abril', 'maio', 'junho', 
                          'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'];
            const mes = meses[data.getMonth()];
            return `${dia} de ${mes}`;
        }

        // Fun√ß√£o para gerar link do WhatsApp
        function gerarLinkWhatsApp(telefone, cliente, data, hora) {
            // Remover caracteres n√£o num√©ricos do telefone
            const telefoneLimpo = telefone.replace(/\D/g, '');
            
            // Formatar data por extenso
            const dataExtenso = formatarDataExtenso(data);
            
            // Mensagem formatada
            const mensagem = `Oii, tudo bem?
Confirmando sua prova de traje: ${dataExtenso} √†s ${hora} aqui na Mr. Jack.
√â necess√°rio vir provar, para confer√™ncia dos ajustes, se estiver tudo certo, voc√™ j√° leva o traje no mesmo dia.
Como estamos em alto fluxo, pedimos que chegue no hor√°rio combinado pra garantir seu atendimento certinho.
Posso confirmar? ‚ú®`;
            
            // Codificar mensagem para URL
            const mensagemCodificada = encodeURIComponent(mensagem);
            
            // Retornar link do WhatsApp
            return `https://wa.me/55${telefoneLimpo}?text=${mensagemCodificada}`;
        }

        // Fun√ß√£o para buscar estat√≠sticas do Mr Jack no m√™s atual
        async function buscarEstatisticasMrJack() {
            try {
                const hoje = new Date();
                const ano = hoje.getFullYear();
                const mes = String(hoje.getMonth() + 1).padStart(2, '0');
                
                // Primeiro e √∫ltimo dia do m√™s
                const primeiroDia = `${ano}-${mes}-01`;
                const ultimoDia = `${ano}-${mes}-${new Date(ano, hoje.getMonth() + 1, 0).getDate()}`;
                
                console.log(`Buscando agendamentos do Mr Jack entre ${primeiroDia} e ${ultimoDia}`);
                
                const q = query(
                    collection(db, 'agendamentos'),
                    where('data', '>=', primeiroDia),
                    where('data', '<=', ultimoDia),
                    orderBy('data', 'asc')
                );

                const querySnapshot = await getDocs(q);
                
                let totalMrJack = 0;
                let porStatus = {
                    agendado: 0,
                    confirmado: 0,
                    cancelado: 0
                };
                
                querySnapshot.forEach((doc) => {
                    const dados = doc.data();
                    const funcionario = dados.funcionario || '';
                    
                    // Verificar se √© Mr Jack
                    if (funcionario.toLowerCase().includes('mrjack') || 
                        funcionario.toLowerCase().includes('mr jack') || 
                        funcionario.toLowerCase().includes('mr.jack')) {
                        totalMrJack++;
                        
                        const status = dados.status || 'agendado';
                        if (porStatus[status] !== undefined) {
                            porStatus[status]++;
                        }
                    }
                });
                
                return {
                    total: totalMrJack,
                    porStatus: porStatus,
                    mesNome: hoje.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })
                };
                
            } catch (error) {
                console.error('Erro ao buscar estat√≠sticas:', error);
                return null;
            }
        }

        // Fun√ß√£o para exibir estat√≠sticas do Mr Jack
        function exibirEstatisticasMrJack(stats) {
            const container = document.getElementById('estatisticasMrJack');
            
            if (!stats || stats.total === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = `
                <div class="estatisticas-mrjack">
                    <h2>
                        üë®‚Äçüíº Estat√≠sticas - MR JACK
                    </h2>
                    <p style="margin: 0; opacity: 0.95; font-size: 1.1em;">
                        Agendamentos em ${stats.mesNome}
                    </p>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">üìä TOTAL NO M√äS</div>
                            <div class="stat-number">${stats.total}</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-label">‚è∞ AGENDADOS</div>
                            <div class="stat-number">${stats.porStatus.agendado}</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-label">‚úÖ CONFIRMADOS</div>
                            <div class="stat-number">${stats.porStatus.confirmado}</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-label">‚ùå CANCELADOS</div>
                            <div class="stat-number">${stats.porStatus.cancelado}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Fun√ß√£o para carregar agendamentos do Firebase
        async function carregarAgendamentosFirebase() {
            try {
                // Data de hoje no formato YYYY-MM-DD
                const hoje = new Date();
                const hojeFormatado = hoje.toISOString().split('T')[0];
                
                console.log('Buscando agendamentos a partir de:', hojeFormatado);

                const q = query(
                    collection(db, 'agendamentos'),
                    where('data', '>=', hojeFormatado),
                    orderBy('data', 'asc'),
                    orderBy('hora', 'asc')
                );

                const querySnapshot = await getDocs(q);
                const agendamentos = [];

                querySnapshot.forEach((doc) => {
                    const dadosDoc = doc.data();
                    agendamentos.push({
                        id: doc.id,
                        cliente: dadosDoc.cliente || 'N√£o informado',
                        data: dadosDoc.data || '',
                        funcionario: dadosDoc.funcionario || 'N√£o definido',
                        hora: dadosDoc.hora || '',
                        observacoes: dadosDoc.observacoes || '',
                        servico: dadosDoc.servico || 'N√£o especificado',
                        status: dadosDoc.status || 'agendado',
                        telefone: dadosDoc.telefone || 'N√£o informado'
                    });
                });

                console.log('Agendamentos encontrados:', agendamentos.length);
                return agendamentos;

            } catch (error) {
                console.error('Erro ao carregar agendamentos:', error);
                throw error;
            }
        }

        // Fun√ß√£o para agrupar agendamentos por data
        function agruparPorData(agendamentos) {
            const grupos = {};
            
            agendamentos.forEach(agendamento => {
                const data = agendamento.data;
                if (!grupos[data]) {
                    grupos[data] = [];
                }
                grupos[data].push(agendamento);
            });
            
            return grupos;
        }

        // Fun√ß√£o para gerar PDF de um dia espec√≠fico
        function gerarPDFDoDia(data, agendamentos) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configura√ß√£o da fonte
            doc.setFont('helvetica');
            
            // Cabe√ßalho
            doc.setFontSize(20);
            doc.setTextColor(40, 40, 40);
            doc.text('AGENDAMENTOS - MR. JACK', 20, 25);
            
            // Data
            doc.setFontSize(16);
            doc.setTextColor(60, 60, 60);
            const dataFormatada = formatarDataBR(data);
            const diaSemana = new Date(data + 'T00:00:00').toLocaleDateString('pt-BR', { weekday: 'long' });
            doc.text(`${diaSemana.toUpperCase()}, ${dataFormatada}`, 20, 35);
            
            // Linha separadora
            doc.setDrawColor(52, 152, 219);
            doc.setLineWidth(0.8);
            doc.line(20, 40, 190, 40);
            
            let yPosition = 55;
            
            if (agendamentos.length === 0) {
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.text('Nenhum agendamento para este dia.', 20, yPosition);
            } else {
                // Cabe√ßalho da tabela
                doc.setFontSize(9);
                doc.setTextColor(60, 60, 60);
                doc.setFont('helvetica', 'bold');
                doc.text('HOR√ÅRIO', 20, yPosition);
                doc.text('CLIENTE', 45, yPosition);
                doc.text('TELEFONE', 95, yPosition);
                doc.text('FUNCION√ÅRIO', 135, yPosition);
                doc.text('SERVI√áO', 175, yPosition);
                
                // Linha do cabe√ßalho
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.3);
                doc.line(20, yPosition + 2, 190, yPosition + 2);
                
                yPosition += 10;
                
                // Ordenar por hora
                agendamentos.sort((a, b) => a.hora.localeCompare(b.hora));
                
                agendamentos.forEach((agendamento, index) => {
                    // Verificar se precisa de nova p√°gina
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 30;
                        
                        // Repetir cabe√ßalho na nova p√°gina
                        doc.setFontSize(9);
                        doc.setTextColor(60, 60, 60);
                        doc.setFont('helvetica', 'bold');
                        doc.text('HOR√ÅRIO', 20, yPosition);
                        doc.text('CLIENTE', 45, yPosition);
                        doc.text('TELEFONE', 95, yPosition);
                        doc.text('FUNCION√ÅRIO', 135, yPosition);
                        doc.text('SERVI√áO', 175, yPosition);
                        doc.line(20, yPosition + 2, 190, yPosition + 2);
                        yPosition += 10;
                    }
                    
                    // Alternar cor de fundo das linhas
                    if (index % 2 === 0) {
                        doc.setFillColor(248, 249, 250);
                        doc.rect(15, yPosition - 3, 180, 8, 'F');
                    }
                    
                    // Hor√°rio
                    doc.setFontSize(9);
                    doc.setTextColor(40, 40, 40);
                    doc.setFont('helvetica', 'bold');
                    doc.text(agendamento.hora, 20, yPosition);
                    
                    // Cliente (limitado para caber na linha)
                    doc.setFont('helvetica', 'normal');
                    let cliente = agendamento.cliente.length > 16 ? 
                                 agendamento.cliente.substring(0, 16) + '...' : 
                                 agendamento.cliente;
                    doc.text(cliente, 45, yPosition);
                    
                    // Telefone
                    let telefone = agendamento.telefone.length > 13 ? 
                                  agendamento.telefone.substring(0, 13) + '...' : 
                                  agendamento.telefone;
                    doc.text(telefone, 95, yPosition);
                    
                    // Funcion√°rio
                    let funcionario = agendamento.funcionario.length > 13 ? 
                                     agendamento.funcionario.substring(0, 13) + '...' : 
                                     agendamento.funcionario;
                    doc.text(funcionario, 135, yPosition);
                    
                    // Servi√ßo (limitado para caber na linha)
                    doc.setTextColor(40, 40, 40);
                    doc.setFont('helvetica', 'normal');
                    let servico = agendamento.servico.length > 15 ? 
                                 agendamento.servico.substring(0, 15) + '...' : 
                                 agendamento.servico;
                    doc.text(servico, 175, yPosition);
                    
                    yPosition += 8;
                });
                
                // Resumo no final
                yPosition += 15;
                if (yPosition > 260) {
                    doc.addPage();
                    yPosition = 30;
                }
                
                // Box do resumo
                doc.setFillColor(52, 152, 219);
                doc.roundedRect(15, yPosition - 5, 180, 20, 3, 3, 'F');
                
                doc.setFontSize(11);
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.text(`TOTAL: ${agendamentos.length} agendamentos`, 20, yPosition + 3);
                
                // Contagem por status na mesma linha
                const statusCount = agendamentos.reduce((acc, ag) => {
                    acc[ag.status] = (acc[ag.status] || 0) + 1;
                    return acc;
                }, {});
                
                let statusText = '';
                Object.entries(statusCount).forEach(([status, count]) => {
                    statusText += `${status}: ${count}  `;
                });
                
                doc.setFontSize(9);
                doc.text(statusText, 20, yPosition + 10);
            }
            
            // Rodap√©
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 20, 285);
            
            // Salvar o PDF
            const nomeArquivo = `agendamentos_${data}_mr_jack.pdf`;
            doc.save(nomeArquivo);
        }

        // Fun√ß√£o para exibir agendamentos agrupados por data
        function exibirAgendamentosAgrupados(agendamentos) {
            const container = document.getElementById('listaAgendamentos');

            if (agendamentos.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <h3>üòä Nenhum agendamento encontrado</h3>
                        <p>N√£o h√° agendamentos marcados ${dataFiltrada ? 'para esta data' : 'a partir de hoje'}.</p>
                    </div>
                `;
                return;
            }

            const gruposPorData = agruparPorData(agendamentos);
            let html = '';
            
            // Ordenar as datas
            const datasOrdenadas = Object.keys(gruposPorData).sort();
            
            datasOrdenadas.forEach(data => {
                const agendamentosDoDia = gruposPorData[data];
                const dataFormatada = formatarDataBR(data);
                const diaSemana = new Date(data + 'T00:00:00').toLocaleDateString('pt-BR', { weekday: 'long' });
                
                html += `
                    <div class="agendamentos-do-dia">
                        <div class="data-header">
                            <div>
                                <h2 class="data-titulo">
                                    üìÖ ${diaSemana.charAt(0).toUpperCase() + diaSemana.slice(1)}, ${dataFormatada}
                                </h2>
                                <p style="margin: 5px 0 0 0; opacity: 0.9;">${agendamentosDoDia.length} agendamento${agendamentosDoDia.length !== 1 ? 's' : ''}</p>
                            </div>
                            <button class="pdf-btn" onclick="window.gerarPDFDoDia('${data}', ${JSON.stringify(agendamentosDoDia).replace(/"/g, '&quot;')})">
                                üìÑ Baixar PDF
                            </button>
                        </div>
                `;
                
                // Ordenar agendamentos do dia por hora
                agendamentosDoDia.sort((a, b) => a.hora.localeCompare(b.hora));
                
                agendamentosDoDia.forEach(agendamento => {
                    const linkWhatsApp = gerarLinkWhatsApp(agendamento.telefone, agendamento.cliente, agendamento.data, agendamento.hora);
                    
                    html += `
                        <div class="card-agendamento">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h3 style="margin: 0;">üë§ ${agendamento.cliente}</h3>
                                <a href="${linkWhatsApp}" target="_blank" class="whatsapp-btn">
                                    <span class="whatsapp-icon">üí¨</span>
                                    Confirmar WhatsApp
                                </a>
                            </div>
                            
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">üïê Hora:</span>
                                    <span><strong>${agendamento.hora}</strong></span>
                                </div>
                                
                                <div class="info-item">
                                    <span class="info-label">üë®‚Äçüíº Funcion√°rio:</span>
                                    <span>${agendamento.funcionario}</span>
                                </div>
                                
                                <div class="info-item">
                                    <span class="info-label">üíº Servi√ßo:</span>
                                    <span>${agendamento.servico}</span>
                                </div>
                                
                                <div class="info-item">
                                    <span class="info-label">üìã Status:</span>
                                    <span class="status-${agendamento.status}">${agendamento.status.toUpperCase()}</span>
                                </div>
                                
                                <div class="info-item">
                                    <span class="info-label">üìû Telefone:</span>
                                    <span>${agendamento.telefone}</span>
                                </div>
                            </div>
                            
                            ${agendamento.observacoes ? `
                                <div class="observacoes">
                                    <strong>üìù Observa√ß√µes:</strong> ${agendamento.observacoes}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
            });

            container.innerHTML = html;
        }
        
        // Fun√ß√£o para filtrar por data espec√≠fica
        function filtrarPorData() {
            const inputData = document.getElementById('dataBusca');
            const dataSelecionada = inputData.value;
            
            if (!dataSelecionada) {
                alert('Por favor, selecione uma data!');
                return;
            }
            
            dataFiltrada = dataSelecionada;
            
            // Filtrar agendamentos da data selecionada
            const agendamentosFiltrados = todosAgendamentos.filter(ag => ag.data === dataSelecionada);
            
            // Exibir indicador de filtro ativo
            const filtroContainer = document.getElementById('filtroAtivo');
            const dataFormatada = formatarDataBR(dataSelecionada);
            filtroContainer.innerHTML = `
                <div class="filtro-ativo">
                    <div>
                        <strong>üîç Filtro Ativo:</strong> Exibindo apenas agendamentos de ${dataFormatada}
                    </div>
                    <button class="clear-btn" onclick="limparFiltro()" style="padding: 8px 16px; font-size: 14px;">
                        ‚úñÔ∏è Remover Filtro
                    </button>
                </div>
            `;
            
            // Exibir agendamentos filtrados
            exibirAgendamentosAgrupados(agendamentosFiltrados);
        }
        
        // Fun√ß√£o para limpar filtro
        function limparFiltro() {
            dataFiltrada = null;
            document.getElementById('dataBusca').value = '';
            document.getElementById('filtroAtivo').innerHTML = '';
            
            // Exibir todos os agendamentos novamente
            exibirAgendamentosAgrupados(todosAgendamentos);
        }
        
        // Fun√ß√£o para baixar CSV com nomes dos clientes
        function baixarCSVClientes() {
            if (todosAgendamentos.length === 0) {
                alert('Nenhum agendamento dispon√≠vel. Por favor, carregue os agendamentos primeiro.');
                return;
            }
            
            // Extrair apenas os nomes dos clientes
            const nomesClientes = todosAgendamentos.map(ag => ag.cliente);
            
            // Remover duplicatas
            const nomesUnicos = [...new Set(nomesClientes)];
            
            // Ordenar alfabeticamente
            nomesUnicos.sort();
            
            // Criar conte√∫do CSV
            let csvContent = "Nome do Cliente\n"; // Cabe√ßalho
            
            nomesUnicos.forEach(nome => {
                csvContent += `"${nome}"\n`;
            });
            
            // Criar blob e download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            // Nome do arquivo com data atual
            const hoje = new Date();
            const dataFormatada = hoje.toISOString().split('T')[0];
            const nomeArquivo = `clientes_agendados_${dataFormatada}.csv`;
            
            // Criar link de download
            if (navigator.msSaveBlob) { // IE 10+
                navigator.msSaveBlob(blob, nomeArquivo);
            } else {
                link.href = URL.createObjectURL(blob);
                link.download = nomeArquivo;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            console.log(`‚úÖ CSV gerado com ${nomesUnicos.length} clientes √∫nicos`);
            alert(`‚úÖ CSV baixado com sucesso!\n\nTotal de clientes √∫nicos: ${nomesUnicos.length}`);
        }

        // Fun√ß√£o principal com debug
        async function carregarAgendamentos() {
            const container = document.getElementById('listaAgendamentos');
            
            try {
                container.innerHTML = '<div class="loading">‚è≥ Carregando agendamentos...</div>';
                
                // Buscar estat√≠sticas do Mr Jack primeiro
                const stats = await buscarEstatisticasMrJack();
                exibirEstatisticasMrJack(stats);
                
                // Buscar agendamentos
                const agendamentos = await carregarAgendamentosFirebase();
                
                // Armazenar globalmente
                todosAgendamentos = agendamentos;
                
                console.log('‚úÖ Agendamentos carregados com sucesso:', agendamentos.length);
                
                // Limpar filtro ao recarregar
                limparFiltro();
                
            } catch (error) {
                console.error('‚ùå Erro completo:', error);
                console.error('‚ùå Stack trace:', error.stack);
                
                let errorMessage = error.message;
                let errorDetails = '';
                
                // Identificar tipos espec√≠ficos de erro
                if (error.code) {
                    switch (error.code) {
                        case 'failed-precondition':
                            errorMessage = '√çndice necess√°rio n√£o foi criado no Firestore';
                            errorDetails = 'Clique no link que aparecer√° no console para criar o √≠ndice automaticamente.';
                            break;
                        case 'permission-denied':
                            errorMessage = 'Permiss√£o negada para acessar o Firestore';
                            errorDetails = 'Verifique as regras de seguran√ßa do Firestore.';
                            break;
                        case 'unavailable':
                            errorMessage = 'Firestore temporariamente indispon√≠vel';
                            errorDetails = 'Tente novamente em alguns segundos.';
                            break;
                    }
                }
                
                container.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erro ao carregar agendamentos</h3>
                        <p><strong>Tipo:</strong> ${error.code || 'Erro desconhecido'}</p>
                        <p><strong>Mensagem:</strong> ${errorMessage}</p>
                        ${errorDetails ? `<p><strong>Solu√ß√£o:</strong> ${errorDetails}</p>` : ''}
                        <hr>
                        <details style="margin-top: 10px;">
                            <summary><strong>üîç Mostrar detalhes t√©cnicos</strong></summary>
                            <div style="background: #f8f8f8; padding: 15px; margin-top: 10px; border-radius: 4px; font-size: 12px;">
                                <p><strong>Erro original:</strong> ${error.message}</p>
                                <p><strong>C√≥digo:</strong> ${error.code || 'N√£o definido'}</p>
                                <pre style="white-space: pre-wrap; margin-top: 10px;">${error.stack || 'Stack n√£o dispon√≠vel'}</pre>
                            </div>
                        </details>
                        <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 4px;">
                            <p><strong>üí° Dica:</strong> Abra o Console do navegador (F12) para ver mais detalhes.</p>
                        </div>
                    </div>
                `;
            }
        }

        // Tornar fun√ß√µes globais para os bot√µes
        window.carregarAgendamentos = carregarAgendamentos;
        window.gerarPDFDoDia = gerarPDFDoDia;
        window.filtrarPorData = filtrarPorData;
        window.limparFiltro = limparFiltro;

        // Carregar automaticamente quando a p√°gina abrir
        document.addEventListener('DOMContentLoaded', carregarAgendamentos);
    </script>
</body>
</html>
